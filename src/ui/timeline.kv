#  Copyright (c) 2021 author(s) of JulianBC.
#
#  This file is part of JulianBC.
#
#  JulianBC is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  JulianBC is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with JulianBC.  If not, see <https://www.gnu.org/licenses/>.
#:kivy 2.0.0
#:import hex kivy.utils.get_color_from_hex
#:import gregorian_cdt src.dbsetup.gregorian_cdt
#:import CollapseBar src.ui.collapse.CollapseBar
#:import EventView src.ui.eventview.EventView
#:import Mark src.ui.mark.Mark
#:import MarkBar src.ui.markbar.MarkBar
<TimelineScreen>:
    name: "timeline_screen"

    Timeline:
        id: timeline_1
        expanded_height: self.parent.height
        collapsable: False  # todo let timelinescreen drive collapability
        cdt: gregorian_cdt
        mark_interval: gregorian_cdt.initial_interval

<Timeline>:
    id: timeline
    size_hint: None, None
    width: sp(1366)  # todo monitor resolution
    collapsed_height: collapse_bar.height
    collapsed: True if collapse_bar.dependant_collapsed else False
    focus_next: event_view
    # todo timelinescreen determines focus previous
    mark: mark
    event_view: event_view

    CollapseBar:
        id: collapse_bar
        pos_hint: {"top": 1}
        dependant: collapse_layout
        collapsable: timeline.collapsable
        focus_next: mark_bar
        # todo focus_previous is previous timeline or header bar
        keyboard_listener: timeline
        label_text: timeline.cdt.date.calendar.name if timeline.cdt else ""  # todo convenience method for calendar name

        CollapseLayout:
            id: collapse_layout
            size_hint: 1, None
            expanded_height: timeline.expanded_height - collapse_bar.height
            collapsed_height: timeline.collapsed_height
            expanded_y: collapse_bar.y - self.expanded_height

            EventView:
                id: event_view
                size_hint: 1, None
                height: collapse_layout.height - mark_bar.height
                focus_next: self # todo focus next should be next event or next collapse bar? focus will always change with right/left scroll in this case, maybe another property like "only gain focus if give focus and focus_next/focus_previous don't ahve focus"
                focus_previous: mark_bar
                keyboard_listener: timeline

            MarkBar:
                id: mark_bar
                size_hint: 1, None
                pos_hint: {"top": 1}
                height: mark.font_size * 2
                focus_next: event_view
                focus_previous: collapse_bar
                keyboard_listener: timeline

            Mark:
                id: mark
                timeline: timeline
                mark_height: self.height
                label_align: Mark.LABEL_MID_INTERVAL
                visible: False if collapse_bar.dependant_collapsed else True